# MinKV (FlashCache)

> A high-performance, concurrent, in-memory key-value store for C++ applications.  
> ä¸“ä¸ºé«˜å¹¶å‘è®¾è®¡çš„ C++ æœ¬åœ°ç¼“å­˜åº“ï¼Œæ€§èƒ½è¶…è¶Šæ ‡å‡†åº“ 7 å€ã€‚

## ğŸš€ æ ¸å¿ƒç‰¹æ€§ (Key Features)

*   **æè‡´å¹¶å‘**: é‡‡ç”¨ **Sharded Locking (åˆ†ç‰‡é”)** æ¶æ„ï¼Œå°†å¤§é”æ‹†åˆ†ä¸º 32+ ä¸ªç‹¬ç«‹åˆ†ç‰‡ï¼Œå¤§å¹…å‡å°‘é”ç«äº‰ã€‚
*   **è¯»å¤šå†™å°‘ä¼˜åŒ–**: å¼•å…¥ **`std::shared_mutex` (è¯»å†™é”)** é…åˆ **Lazy LRU Promotion**ï¼Œè®© 99% çš„ `get` æ“ä½œå˜ä¸ºæ— é”å¹¶å‘è¯»ã€‚
*   **å·¥ä¸šçº§ç‰¹æ€§**: æ”¯æŒ **TTL (è‡ªåŠ¨è¿‡æœŸ)**ã€**æœ€å¤§å®¹é‡é™åˆ¶**ã€**LRU æ·˜æ±°**ã€‚
*   **é›¶æ‹·è´æ¥å£**: ç²¾å¿ƒè®¾è®¡çš„ APIï¼Œå‡å°‘ä¸å¿…è¦çš„å†…å­˜æ‹·è´ã€‚

---

## ğŸ“Š æ€§èƒ½å‹æµ‹ (Benchmark)

![Benchmark Result](assets/benchmark_performance.png)

æˆ‘ä»¬åœ¨ 16 æ ¸æœåŠ¡å™¨ä¸Šè¿›è¡Œäº†é«˜å¹¶å‘å‹æµ‹ï¼Œå¯¹æ¯”äº† `MinKV`ã€`std::unordered_map + std::mutex` ä»¥åŠ `Redis (localhost)`ã€‚

### 1. ååé‡ (Throughput / QPS)

MinKV å±•ç°äº†è¿‘ä¹çº¿æ€§çš„æ‰©å±•èƒ½åŠ›ï¼Œè€Œæ ‡å‡†åº“æ–¹æ¡ˆåœ¨é«˜å¹¶å‘ä¸‹å› é”ç«äº‰å¯¼è‡´æ€§èƒ½å´©å¡Œã€‚

| çº¿ç¨‹æ•° | StdMap + Mutex | **MinKV (FlashCache)** | Redis (Local) |
| :---: | :---: | :---: | :---: |
| 1 | 1.2M | 1.0M | 0.1M |
| 4 | 0.9M | 3.2M | 0.1M |
| 8 | 0.8M | 4.8M | 0.1M |
| **16** | **0.8M** | **5.5M (ğŸš€ 6.8x)** | 0.1M |

### 2. P99 å»¶è¿Ÿ (Latency)

åœ¨é«˜è´Ÿè½½ä¸‹ï¼ŒMinKV ä¾ç„¶ä¿æŒå¾®ç§’çº§çš„å“åº”é€Ÿåº¦ã€‚

*   **MinKV**: ~20 Î¼s (16çº¿ç¨‹) â€”â€” **æå…¶ç¨³å®š**
*   **StdMap**: ~150 Î¼s (16çº¿ç¨‹) â€”â€” éšå¹¶å‘æ•°çº¿æ€§æ¶åŒ–
*   **Redis**: ~200 Î¼s â€”â€” å—åˆ°ç½‘ç»œ IO é™åˆ¶

> **ç»“è®º**: åœ¨å¤šçº¿ç¨‹æœ¬åœ°ç¼“å­˜åœºæ™¯ä¸‹ï¼ŒMinKV ç›¸æ¯”æ ‡å‡†åº“æ–¹æ¡ˆæä¾›äº† **7å€çš„ååé‡** å’Œ **æ›´ä½çš„å»¶è¿ŸæŠ–åŠ¨**ã€‚

---

## ğŸ› ï¸ å¿«é€Ÿå¼€å§‹ (Quick Start)

### é›†æˆ

åªéœ€åŒ…å«å¤´æ–‡ä»¶å³å¯ä½¿ç”¨ï¼š

```cpp
#include "db/sharded_cache.h"
#include <string>
#include <iostream>

int main() {
    // åˆ›å»ºä¸€ä¸ªåˆ†ç‰‡ç¼“å­˜
    // æ¯ä¸ªåˆ†ç‰‡å®¹é‡ 10000ï¼Œå…± 32 ä¸ªåˆ†ç‰‡ -> æ€»å®¹é‡ 320,000
    minkv::db::ShardedCache<std::string, std::string> cache(10000, 32);

    // 1. å†™å…¥æ•°æ® (æ”¯æŒ TTL)
    cache.put("user:1001", "Robinson", 5000); // 5ç§’åè¿‡æœŸ

    // 2. è¯»å–æ•°æ®
    auto value = cache.get("user:1001");
    if (value) {
        std::cout << "Found: " << *value << std::endl;
    } else {
        std::cout << "Not found or expired" << std::endl;
    }

    // 3. å¹¶å‘å®‰å…¨
    // ä½ å¯ä»¥åœ¨å¤šä¸ªçº¿ç¨‹ä¸­å®‰å…¨åœ°è°ƒç”¨ get/putï¼Œæ— éœ€é¢å¤–åŠ é”
    
    return 0;
}
```


## ğŸ—ï¸ æ¶æ„è®¾è®¡ (Architecture)

### ä¸ºä»€ä¹ˆæ ‡å‡†åº“ (`std::map` + `mutex`) æ…¢ï¼Ÿ
æ ‡å‡†åº“æ–¹æ¡ˆä½¿ç”¨ä¸€æŠŠå…¨å±€äº’æ–¥é”ã€‚å½“ 16 ä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®æ—¶ï¼Œå®ƒä»¬å¿…é¡»ä¸²è¡Œæ’é˜Ÿã€‚è¿™è¢«ç§°ä¸º **Lock Contention (é”ç«äº‰)**ï¼Œæ˜¯é«˜å¹¶å‘ç³»ç»Ÿçš„æ€æ‰‹ã€‚

### MinKV æ˜¯å¦‚ä½•ä¼˜åŒ–çš„ï¼Ÿ
1.  **Sharding (åˆ†ç‰‡)**: å°†æ•°æ®æŒ‰ Hash åˆ†æ•£åˆ° 32 ä¸ªç‹¬ç«‹çš„ Bucketï¼Œç†è®ºä¸Šå°†é”ç«äº‰é™ä½äº† 32 å€ã€‚
2.  **Reader-Writer Lock (è¯»å†™é”)**: 99% çš„è¯·æ±‚æ˜¯è¯»ã€‚æˆ‘ä»¬ä½¿ç”¨ `shared_mutex`ï¼Œå…è®¸å¤šä¸ªè¯»è€…åŒæ—¶è¿›å…¥ï¼Œåªæœ‰å†™è€…éœ€è¦ç‹¬å ã€‚
3.  **Lazy LRU**: ä¼ ç»Ÿçš„ LRU æ¯æ¬¡è¯»å–éƒ½è¦ä¿®æ”¹é“¾è¡¨ï¼ˆå†™æ“ä½œï¼‰ã€‚æˆ‘ä»¬å¼•å…¥ **Lazy Promotion**ï¼Œ1ç§’å†…é‡å¤è®¿é—®ä¸ç§»åŠ¨é“¾è¡¨ï¼Œå°† 99% çš„ `get` è¿˜åŸä¸ºçº¯è¯»æ“ä½œï¼Œå½»åº•é‡Šæ”¾äº†è¯»å†™é”çš„å¨åŠ›ã€‚

---

**License**: MIT  
**Author**: Robinson
