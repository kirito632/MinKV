# MinKV (FlashCache)

> A high-performance, concurrent, in-memory key-value store for C++ applications.  
> ä¸“ä¸ºé«˜å¹¶å‘è®¾è®¡çš„ C++ æœ¬åœ°ç¼“å­˜åº“ã€‚

## ğŸš€ æ ¸å¿ƒç‰¹æ€§ (Key Features)

*   **æè‡´å¹¶å‘**: é‡‡ç”¨ **Sharded Locking (åˆ†ç‰‡é”)** æ¶æ„ï¼Œå°†å¤§é”æ‹†åˆ†ä¸º 32+ ä¸ªç‹¬ç«‹åˆ†ç‰‡ï¼Œå¤§å¹…å‡å°‘é”ç«äº‰ã€‚
*   **è¯»å¤šå†™å°‘ä¼˜åŒ–**: å¼•å…¥ **`std::shared_mutex` (è¯»å†™é”)** é…åˆ **Lazy LRU Promotion**ï¼Œè®© 99% çš„ `get` æ“ä½œå˜ä¸ºæ— é”å¹¶å‘è¯»ã€‚
*   **å·¥ä¸šçº§ç‰¹æ€§**: æ”¯æŒ **TTL (è‡ªåŠ¨è¿‡æœŸ)**ã€**æœ€å¤§å®¹é‡é™åˆ¶**ã€**LRU æ·˜æ±°**ã€‚
*   **é›¶æ‹·è´æ¥å£**: ç²¾å¿ƒè®¾è®¡çš„ APIï¼Œå‡å°‘ä¸å¿…è¦çš„å†…å­˜æ‹·è´ã€‚

---

## ğŸ“Š æ€§èƒ½å‹æµ‹ (Benchmark)

> åŸºäºè…¾è®¯äº‘ 8æ ¸32GB äº‘æœåŠ¡å™¨çš„çœŸå®æµ‹è¯•æ•°æ® (è¯¦è§ `docs/PERFORMANCE_TESTING_REPORT.md`)

### æ ¸å¿ƒæ€§èƒ½æŒ‡æ ‡

*   **å³°å€¼ååé‡**: **247ä¸‡ QPS** (4çº¿ç¨‹, 32åˆ†ç‰‡, ç»¼åˆæµ‹è¯•)
*   **æé™ååé‡**: **288ä¸‡ QPS** (8çº¿ç¨‹, 64åˆ†ç‰‡, åˆ†ç‰‡æ¶ˆèæµ‹è¯•)
*   **P99å»¶è¿Ÿ**: **2.06 Î¼s** (å¾®ç§’çº§å“åº”)
*   **WALæŒä¹…åŒ–å¼€é”€**: ä»… **8.7%** (ååé‡ä»270ä¸‡é™è‡³247ä¸‡)
*   **SIMDåŠ é€Ÿ**: ç®—æ³•çº§åˆ« **4.58å€** æå‡ (å‘é‡ç›¸ä¼¼åº¦è®¡ç®—)

### 1. ç»¼åˆæ€§èƒ½æµ‹è¯• (Comprehensive Benchmark)

åœ¨çœŸå®äº‘æœåŠ¡å™¨ç¯å¢ƒä¸‹ï¼ŒMinKVå±•ç°äº†å“è¶Šçš„å¹¶å‘æ€§èƒ½ï¼š

| çº¿ç¨‹æ•° | ååé‡ (QPS) | P50å»¶è¿Ÿ | P99å»¶è¿Ÿ | P999å»¶è¿Ÿ |
| :---: | :---: | :---: | :---: | :---: |
| 1 | 79.4ä¸‡ | 1.26 Î¼s | 1.46 Î¼s | 1.66 Î¼s |
| 2 | 158ä¸‡ | 1.26 Î¼s | 1.56 Î¼s | 1.86 Î¼s |
| **4** | **247ä¸‡** | **1.36 Î¼s** | **2.06 Î¼s** | **2.76 Î¼s** |
| 8 | 237ä¸‡ | 3.36 Î¼s | 5.06 Î¼s | 6.76 Î¼s |

### 2. åˆ†ç‰‡æ•°æ¶ˆèæµ‹è¯• (Shard Count Ablation)

éªŒè¯äº†åˆ†ç‰‡ç­–ç•¥çš„æœ‰æ•ˆæ€§ (8çº¿ç¨‹æµ‹è¯•)ï¼š

| åˆ†ç‰‡æ•° | ååé‡ (QPS) | æ€§èƒ½æå‡ |
| :---: | :---: | :---: |
| 1 | 79.4ä¸‡ | åŸºå‡† |
| 8 | 158ä¸‡ | 2.0x |
| 16 | 237ä¸‡ | 3.0x |
| 32 | 270ä¸‡ | 3.4x |
| **64** | **288ä¸‡** | **3.6x** |
| 128 | 237ä¸‡ | 3.0x (è¿‡åº¦åˆ†ç‰‡) |

**æœ€ä½³é…ç½®**: 64åˆ†ç‰‡ (8çº¿ç¨‹) æˆ– 32åˆ†ç‰‡ (4çº¿ç¨‹)

### 3. WALæŒä¹…åŒ–æ€§èƒ½

å¯ç”¨WALåæ€§èƒ½å½±å“æå°ï¼Œè¯æ˜äº†è®¾è®¡çš„é«˜æ•ˆæ€§ï¼š

*   **æ— WAL**: 270ä¸‡ QPS
*   **æœ‰WAL**: 247ä¸‡ QPS
*   **æ€§èƒ½æŸå¤±**: ä»… 8.7%

### 4. SIMDå‘é‡åŒ–ä¼˜åŒ–

é’ˆå¯¹å‘é‡ç›¸ä¼¼åº¦è®¡ç®—çš„ä¸“é¡¹ä¼˜åŒ–ï¼š

*   **æ ‡é‡å®ç°**: 21.8 Î¼s/op
*   **SIMDå®ç°**: 4.76 Î¼s/op
*   **åŠ é€Ÿæ¯”**: 4.58x

> **ç»“è®º**: MinKVåœ¨çœŸå®äº‘ç¯å¢ƒä¸‹è¾¾åˆ°äº†**247ä¸‡QPS**çš„å·¥ä¸šçº§æ€§èƒ½ï¼ŒP99å»¶è¿Ÿä¿æŒåœ¨**2å¾®ç§’**ä»¥å†…ï¼ŒåŒæ—¶æ”¯æŒWALæŒä¹…åŒ–å’ŒSIMDåŠ é€Ÿç­‰é«˜çº§ç‰¹æ€§ã€‚

---

## ğŸ› ï¸ å¿«é€Ÿå¼€å§‹ (Quick Start)

### é›†æˆ

åªéœ€åŒ…å«å¤´æ–‡ä»¶å³å¯ä½¿ç”¨ï¼š

```cpp
#include "db/sharded_cache.h"
#include <string>
#include <iostream>

int main() {
    // åˆ›å»ºä¸€ä¸ªåˆ†ç‰‡ç¼“å­˜
    // æ¯ä¸ªåˆ†ç‰‡å®¹é‡ 10000ï¼Œå…± 32 ä¸ªåˆ†ç‰‡ -> æ€»å®¹é‡ 320,000
    minkv::db::ShardedCache<std::string, std::string> cache(10000, 32);

    // 1. å†™å…¥æ•°æ® (æ”¯æŒ TTL)
    cache.put("user:1001", "Robinson", 5000); // 5ç§’åè¿‡æœŸ

    // 2. è¯»å–æ•°æ®
    auto value = cache.get("user:1001");
    if (value) {
        std::cout << "Found: " << *value << std::endl;
    } else {
        std::cout << "Not found or expired" << std::endl;
    }

    // 3. å¹¶å‘å®‰å…¨
    // ä½ å¯ä»¥åœ¨å¤šä¸ªçº¿ç¨‹ä¸­å®‰å…¨åœ°è°ƒç”¨ get/putï¼Œæ— éœ€é¢å¤–åŠ é”
    
    return 0;
}
```


## ğŸ—ï¸ æ¶æ„è®¾è®¡ (Architecture)

### ä¸ºä»€ä¹ˆæ ‡å‡†åº“ (`std::map` + `mutex`) æ…¢ï¼Ÿ
æ ‡å‡†åº“æ–¹æ¡ˆä½¿ç”¨ä¸€æŠŠå…¨å±€äº’æ–¥é”ã€‚å½“ 16 ä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®æ—¶ï¼Œå®ƒä»¬å¿…é¡»ä¸²è¡Œæ’é˜Ÿã€‚è¿™è¢«ç§°ä¸º **Lock Contention (é”ç«äº‰)**ï¼Œæ˜¯é«˜å¹¶å‘ç³»ç»Ÿçš„æ€æ‰‹ã€‚

### MinKV æ˜¯å¦‚ä½•ä¼˜åŒ–çš„ï¼Ÿ
1.  **Sharding (åˆ†ç‰‡)**: å°†æ•°æ®æŒ‰ Hash åˆ†æ•£åˆ° 32 ä¸ªç‹¬ç«‹çš„ Bucketï¼Œç†è®ºä¸Šå°†é”ç«äº‰é™ä½äº† 32 å€ã€‚
2.  **Reader-Writer Lock (è¯»å†™é”)**: 99% çš„è¯·æ±‚æ˜¯è¯»ã€‚æˆ‘ä»¬ä½¿ç”¨ `shared_mutex`ï¼Œå…è®¸å¤šä¸ªè¯»è€…åŒæ—¶è¿›å…¥ï¼Œåªæœ‰å†™è€…éœ€è¦ç‹¬å ã€‚
3.  **Lazy LRU**: ä¼ ç»Ÿçš„ LRU æ¯æ¬¡è¯»å–éƒ½è¦ä¿®æ”¹é“¾è¡¨ï¼ˆå†™æ“ä½œï¼‰ã€‚æˆ‘ä»¬å¼•å…¥ **Lazy Promotion**ï¼Œ1ç§’å†…é‡å¤è®¿é—®ä¸ç§»åŠ¨é“¾è¡¨ï¼Œå°† 99% çš„ `get` è¿˜åŸä¸ºçº¯è¯»æ“ä½œï¼Œå½»åº•é‡Šæ”¾äº†è¯»å†™é”çš„å¨åŠ›ã€‚

---

**License**: MIT  
**Author**: Robinson
